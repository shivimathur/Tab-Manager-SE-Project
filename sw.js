const RulePrefix="rule-";var Rules,RuleForNoGroup,OneGroupInAll,GroupByDomain;function initRules(){return new Promise(function(a,b){chrome.storage.sync.get(null,function(c){let d=[];for(const [e,f]of Object.entries(c))e.startsWith(RulePrefix)&&(f.enabled??!0)&&d.push(f);d.sort(function(e,f){return e.id.localeCompare(f.id)});Rules=d;RuleForNoGroup="all"!==c["r-scope"];OneGroupInAll=c["r-oneGroupInAll"]??!1;GroupByDomain=c["r-groupByDomain"]??!1;a()})})}var InitPromise=initRules(),regexCaches=new Map;
function matchString(a,b,c,d=!1){if("regex"===b){b=d?c+"++":c;let e=regexCaches.get(b);e||(e=d?new RegExp(c,"iu"):new RegExp(c),regexCaches.set(b,e));return e.test(a)}d&&(a=a.toLocaleLowerCase(),c=c.toLocaleLowerCase());return"equal"===b?a===c:a[b](c)}function matchUrlRule(a){a=new URL(a);for(let b of Rules)if(b.urlMatches)for(let c of b.urlMatches)if(matchString(a[c.target],c.method,c.value))return b;return null}
function matchTitleRule(a){for(let b of Rules)if(b.titleMatches)for(let c of b.titleMatches)if(matchString(a,c.method,c.value,c.ignoreCase))return b;return null}function domainToName(a){a=a.split(".");1<a.length&&a.pop();1<a.length&&"www"==a[0]&&a.shift();return a.join(".")}function matchDomainRule(a){a=new URL(a);return{groupName:domainToName(a.hostname)}};const NoGroup=chrome.tabGroups.TAB_GROUP_ID_NONE,CurrentWindow=chrome.windows.WINDOW_ID_CURRENT;function onTabCreated(a){a.url&&autoGroup(a.url,!0,a)}function onTabUpdated(a,b,c){c.pinned||(b.url?autoGroup(b.url,!0,c):b.title&&autoGroup(b.title,!1,c))}var groupTimeoutIds=new Map;
function checkGroupUnique(a){let b=groupTimeoutIds.get(a);b&&clearTimeout(b);b=setTimeout(function(){groupTimeoutIds.set(a,0);chrome.tabGroups.query({windowId:CurrentWindow,title:a},function(c){if(1<c.length){let d=c.map(f=>f.id),e=d.shift();chrome.tabs.query({windowId:CurrentWindow},function(f){let g=[];for(let h of f)d.includes(h.groupId)&&g.push(h.id);chrome.tabs.group({groupId:e,tabIds:g})})}})},800);groupTimeoutIds.set(a,b)}
async function autoGroup(a,b,c){await InitPromise;let d;if(GroupByDomain)d=b?matchDomainRule(a):null;else{if(RuleForNoGroup&&c.groupId!==NoGroup)return;d=b?matchUrlRule(a):matchTitleRule(a)}if(d){const e=d.groupName;a={title:e};OneGroupInAll||(a.windowId=CurrentWindow);chrome.tabGroups.query(a,function(f){if(0<f.length){if(c.groupId!==NoGroup)for(let h of f)if(c.groupId===h.id)return;const g=c.windowId===f[0].windowId;chrome.tabs.group({tabIds:c.id,groupId:f[0].id},function(){g||chrome.tabs.update(c.id,
{active:!0})})}else chrome.tabs.group({tabIds:c.id},function(g){let h={title:e};d.groupColor&&(h.color=d.groupColor);chrome.tabGroups.update(g,h,k=>checkGroupUnique(e))})})}};class Shortcut{static toggleTabGroup(a){chrome.tabs.query({highlighted:!0,windowId:CurrentWindow},function(b){b=b.map(c=>c.id);a.groupId===NoGroup?chrome.tabs.group({tabIds:b}):chrome.tabs.ungroup(b)})}static ungroup(a){const b=a.groupId;b!==NoGroup&&chrome.tabs.query({windowId:CurrentWindow},function(c){let d=[];for(let e of c)e.groupId===b&&d.push(e.id);chrome.tabs.ungroup(d)})}static ungroupAll(){chrome.tabs.query({windowId:CurrentWindow},function(a){let b=[];for(let c of a)c.groupId!==NoGroup&&
b.push(c.id);0<b.length&&chrome.tabs.ungroup(b)})}static nextTabInGroup(a,b){const c=a.groupId,d=a.id;c!==NoGroup&&chrome.tabs.query({windowId:CurrentWindow},function(e){let f=[],g=0;for(let h=0;h<e.length;h++){let k=e[h];k.groupId===c&&(f.push(k),k.id===d&&(g=f.length-1))}1<f.length&&(b?(g++,g>=f.length&&(g=0)):(g--,0>g&&(g=f.length-1)),chrome.tabs.update(f[g].id,{active:!0}))})}static toggleCollapse(a){const b=a.groupId;b!==NoGroup&&chrome.tabGroups.get(b,function(c){c&&chrome.tabGroups.update(b,
{collapsed:!c.collapsed})})}static toggleCollapseAll(){chrome.tabGroups.query({windowId:CurrentWindow},function(a){if(0<a.length){const b=!a[0].collapsed,c={collapsed:b};for(let d of a)d.collapsed!=b&&chrome.tabGroups.update(d.id,c)}})}static newtabInGroup(a){const b=a.groupId;b!==NoGroup?chrome.tabs.create({},function(c){chrome.tabs.group({groupId:b,tabIds:c.id})}):chrome.tabs.create({})}static moveGroupToNewWindow(a){const b=a.groupId;b!==NoGroup?chrome.windows.create({focused:!0},function(c){chrome.tabGroups.move(b,
{index:0,windowId:c.id},function(){chrome.tabs.update(a.id,{active:!0},function(){chrome.tabs.remove(c.tabs[0].id)})})}):chrome.windows.create({tabId:a.id})}static moveGroup(a,b){chrome.tabs.query({windowId:CurrentWindow},function(c){Shortcut.jumpMove(c,a,b)})}static jumpMove(a,b,c){let d=[],e=-1,f=0;const g=b.id;for(let h=0;h<a.length;h++){let k=a[h];k.pinned?d.push(-1):k.groupId===NoGroup?d.push(h):k.groupId!==e&&(e=k.groupId,d.push(h));k.id===g&&(f=d.length-1)}if(c){if(f==d.length-1)return;b=a[d[f+
1]];if(void 0===b)return}else f--;a=d[f];void 0!==a&&-1!==a&&(b.groupId===NoGroup?chrome.tabs.move(b.id,{index:a}):chrome.tabGroups.move(b.groupId,{index:a}))}static moveTab(a,b){a.pinned||chrome.tabs.query({windowId:CurrentWindow},function(c){let d=b?a.index+1:a.index-1;(c=c[d])&&!c.pinned&&chrome.tabs.move(a.id,{index:d})})}static removeGroup(a){const b=a.groupId;b!==NoGroup&&chrome.tabs.query({windowId:CurrentWindow},function(c){let d=[];for(let e of c)e.groupId===b&&d.push(e.id);chrome.tabs.remove(d)})}static removeTabsNotInThisGroup(a){const b=
a.groupId;b!==NoGroup&&chrome.tabs.query({windowId:CurrentWindow},function(c){let d=[];for(let e of c)e.groupId!==b&&d.push(e.id);chrome.tabs.remove(d)})}static removeUngroupedTabs(a){chrome.tabs.query({windowId:CurrentWindow},function(b){let c=[];for(let d of b)d.groupId===NoGroup&&c.push(d.id);chrome.tabs.remove(c)})}static removeOtherTabs(a){chrome.tabs.query({windowId:CurrentWindow},function(b){let c=[];const d=a.id;for(let e of b)e.id!==d&&c.push(e.id);chrome.tabs.remove(c)})}static removeRightTabs(a,
b){chrome.tabs.query({windowId:CurrentWindow},function(c){b&&c.reverse();const d=a.id;let e=[];for(let f=0;f<c.length;f++){let g=c[f].id;if(g===d)break;else e.push(g)}chrome.tabs.remove(e)})}static addUngroupedTabInThisGroup(a,b){const c=a.groupId;c!==NoGroup&&chrome.tabs.query({windowId:CurrentWindow},function(d){b&&d.reverse();for(let e=0;e<d.length;e++)if(d[e].groupId===c){(d=d[e-1])&&d.groupId===NoGroup&&chrome.tabs.group({groupId:c,tabIds:d.id});break}})}static groupN(a,b){chrome.tabs.query({windowId:CurrentWindow},
function(c){let d=-1,e=0,f;for(let g=0;g<c.length;g++){let h=c[g].groupId;if(h!==NoGroup&&h!==d&&(d=h,e++,f=c[g],9>a&&a===e)){b?chrome.tabs.update(f.id,{active:!0}):Shortcut.toggleCollapse(f);return}}9===a&&f&&(b?chrome.tabs.update(f.id,{active:!0}):Shortcut.toggleCollapse(f))})}static toggleTabPin(a){chrome.tabs.update(a.id,{pinned:!a.pinned})}static autoGroupByDomain(a){chrome.tabs.query({windowId:CurrentWindow},async function(b){let c=new Map;var d=[];let e=[];for(let f of b)if(f.url)if(f.pinned)d.push(f.id);
else{b=new URL(f.url);let g=c.get(b.hostname);g?g.push(f.id):c.set(b.hostname,[f.id])}else e.push(f.id);0<e.length&&await Shortcut.tabsMove(e,-1);d=d.length;for(let [f,g]of c)await Shortcut.tabsMove(g,d),d+=g.length,chrome.tabs.group({tabIds:g},function(h){a?chrome.tabGroups.update(h,{collapsed:!0,title:domainToName(f)}):chrome.tabGroups.update(h,{collapsed:!1,title:""})})})}static tabsMove(a,b){return new Promise(function(c,d){chrome.tabs.move(a,{index:b},c)})}}
function onCommand(a,b){b&&("toggle-tab-group"==a?Shortcut.toggleTabGroup(b):"next-tab-in-group"==a?Shortcut.nextTabInGroup(b,!0):"previous-tab-in-group"==a?Shortcut.nextTabInGroup(b,!1):"toggle-group-collapse"==a?Shortcut.toggleCollapse(b):"toggle-all-group-collapse"==a?Shortcut.toggleCollapseAll():"ungroup-this-group"==a?Shortcut.ungroup(b):"ungroup-all-group"==a?Shortcut.ungroupAll():"group-by-domain-with-name"==a?Shortcut.autoGroupByDomain(!0):"group-by-domain-without-name"==a?Shortcut.autoGroupByDomain(!1):
"newtab-in-group"==a?Shortcut.newtabInGroup(b):"move-group-window"==a?Shortcut.moveGroupToNewWindow(b):"move-group-right"==a?Shortcut.moveGroup(b,!0):"move-group-left"==a?Shortcut.moveGroup(b,!1):"move-tab-right"==a?Shortcut.moveTab(b,!0):"move-tab-left"==a?Shortcut.moveTab(b,!1):"remove-group"==a?Shortcut.removeGroup(b):"remove-ungrouped-tabs"==a?Shortcut.removeUngroupedTabs(b):"remove-tabs-not-in-this-group"==a?Shortcut.removeTabsNotInThisGroup(b):"add-right-tab-in-this-group"==a?Shortcut.addUngroupedTabInThisGroup(b,
!0):"add-left-tab-in-this-group"==a?Shortcut.addUngroupedTabInThisGroup(b,!1):"toggle-tab-pin"==a?Shortcut.toggleTabPin(b):"remove-other-tabs"==a?Shortcut.removeOtherTabs(b):"remove-left-tabs"==a?Shortcut.removeRightTabs(b,!1):"remove-right-tabs"==a?Shortcut.removeRightTabs(b,!0):a.startsWith("active-group-")?(a=parseInt(a.charAt(a.length-1),10),Shortcut.groupN(a,!0)):a.startsWith("collapse-group-")&&(a=parseInt(a.charAt(a.length-1),10),Shortcut.groupN(a,!1)))};class GroupStore{static createTab(a,b){return new Promise(function(c,d){"background"==b?chrome.tabs.create({active:!1,url:a,windowId:CurrentWindow},c):"newWindow"==b?chrome.windows.create({focused:!0,url:a},e=>c(e.tabs[0])):chrome.tabs.create({active:!0,url:a,windowId:CurrentWindow},c)})}static createTabsInWindow(a){return new Promise(function(b,c){chrome.windows.create({focused:!0,url:a},d=>b(d.tabs))})}static openGroup(a,b){chrome.storage.local.get(a,async function(c){let d=c[a];if(d&&0<d.tabs.length)try{let e;
if("newWindow"==b){const g=d.tabs.map(h=>h.url);e=await GroupStore.createTabsInWindow(g)}else{let g=d.tabs.map(h=>GroupStore.createTab(h.url,b));e=await Promise.all(g)}let f=e.map(g=>g.id);d.title?chrome.tabGroups.query({windowId:CurrentWindow,title:d.title},function(g){0<g.length?chrome.tabs.group({groupId:g[0].id,tabIds:f}):chrome.tabs.group({tabIds:f},function(h){chrome.tabGroups.update(h,{title:d.title,color:d.color})})}):chrome.tabs.group({tabIds:f},function(g){chrome.tabGroups.update(g,{color:d.color})})}catch(e){console.error(e)}})}static async openTab(a,
b,c,d){let e=await GroupStore.createTab(a,b);c?chrome.tabGroups.query({windowId:CurrentWindow,title:c},function(f){0<f.length?chrome.tabs.group({groupId:f[0].id,tabIds:e.id}):chrome.tabs.group({tabIds:e.id},function(g){chrome.tabGroups.update(g,{title:c,color:d})})}):chrome.tabs.group({tabIds:e.id},function(f){chrome.tabGroups.update(f,{color:d})})}static moveToWindow(a,b,c){void 0===b?chrome.windows.create({focused:!0},function(d){const e=d.tabs[0].id;"group"===c?chrome.tabGroups.move(a,{index:0,
windowId:d.id},function(){chrome.tabs.remove(e)}):chrome.tabs.move(a,{index:0,windowId:d.id},function(){chrome.tabs.remove(e)})}):"group"===c?chrome.tabGroups.move(a,{index:-1,windowId:b},function(){chrome.windows.update(b,{focused:!0})}):chrome.tabs.move(a,{index:-1,windowId:b},function(){chrome.tabs.update(a,{active:!0},function(){chrome.windows.update(b,{focused:!0})})})}};function onMessage(a,b,c){b=a.type;"OpenTab"==b?GroupStore.openTab(a.url,a.mode,a.groupName,a.groupColor):"OpenGroup"==b?GroupStore.openGroup(a.id,a.mode):"UpdateRule"==b?InitPromise=initRules():"MoveToWindow"==b&&GroupStore.moveToWindow(a.id,a.windowId,a.moveType)}function onInstall(a){a&&"install"==a.reason&&chrome.tabs.create({url:"help.html"})}chrome.runtime.onInstalled.addListener(onInstall);chrome.tabs.onCreated.addListener(onTabCreated);chrome.tabs.onUpdated.addListener(onTabUpdated);chrome.commands.onCommand.addListener(onCommand);
chrome.runtime.onMessage.addListener(onMessage);
